<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <!-- styles -->
    <link type="text/css" href="../css/materialize.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link type="text/css" href="../css/style.css" rel="stylesheet">
    <!-- js links -->
    <script type="text/javascript" src="../js/jquery-3.4.1.min.js"></script>
    <script type="text/javascript" src="../js/materialize.min.js"></script>
    <script type="text/javascript" src="../js/three.js"></script>
    <script src='https://mamboleoo.be/learnThree/demos/OBJLoader.js'></script>
    <title>Fish Pond</title>
    <!-- link to manifest -->
    <link rel="manifest" href="../manifest.json">
    <meta name="theme-color" content="#FFE1C4">
</head>

<body>
    <div id="profile-pond" class="pond">
    </div>
    <script src="../js/wave.js"></script>
    <div class="page-content">
        <!-- HEADER -->
        <div class="head container">
            <ul id="top-bar">
                <li>
                    <h5 class="grey-text text-lighten-4"><b>FishPond</b></h5>
                </li>
                <li>
                    <div id="logout">
                        <i class="btn-flat material-icons grey-text text-lighten-4">exit_to_app</i>
                    </div>
                </li>
            </ul>
        </div>
        <!-- CONTENT -->
        <div class="content container">
            <div id="profile-data" class="container center"></div>
            <h6 class="center white-text">User Fish</h6>
            <div id="user-fish" class="container"></div>
            <div>
                <ul class="collapsible">
                    <li>
                        <div class="collapsible-header"><i class="material-icons">lightbulb_outline</i>Light1</div>
                        <div class="collapsible-body white">
                            <form id="light1">
                                <p>
                                    <label>
                                        <input id="0" name="group1" type="radio" checked />
                                        <span>Blue</span>
                                    </label>
                                </p>
                                <p>
                                    <label>
                                        <input id="1" name="group1" type="radio" />
                                        <span>Purple</span>
                                    </label>
                                </p>
                                <p>
                                    <label>
                                        <input id="2" name="group1" type="radio" />
                                        <span>Red</span>
                                    </label>
                                </p>
                                <p>
                                    <label>
                                        <input id="3" name="group1" type="radio" />
                                        <span>Green</span>
                                    </label>
                                </p>
                                <p>
                                    <label>
                                        <input id="4" name="group1" type="radio" />
                                        <span>Yellow</span>
                                    </label>
                                </p>
                                <p>
                                    <label>
                                        <input id="5" name="group1" type="radio" />
                                        <span>Orange</span>
                                    </label>
                                </p>
                            </form>
                        </div>
                    </li>
                    <li>
                        <div class="collapsible-header"><i class="material-icons">lightbulb_outline</i>Light2</div>
                        <div class="collapsible-body white">
                            <form id="light2">
                                <p>
                                    <label>
                                        <input id="0" name="group1" type="radio" checked />
                                        <span>Blue</span>
                                    </label>
                                </p>
                                <p>
                                    <label>
                                        <input id="1" name="group1" type="radio" />
                                        <span>Purple</span>
                                    </label>
                                </p>
                                <p>
                                    <label>
                                        <input id="2" name="group1" type="radio" />
                                        <span>Red</span>
                                    </label>
                                </p>
                                <p>
                                    <label>
                                        <input id="3" name="group1" type="radio" />
                                        <span>Green</span>
                                    </label>
                                </p>
                                <p>
                                    <label>
                                        <input id="4" name="group1" type="radio" />
                                        <span>Yellow</span>
                                    </label>
                                </p>
                                <p>
                                    <label>
                                        <input id="5" name="group1" type="radio" />
                                        <span>Orange</span>
                                    </label>
                                </p>
                            </form>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
        <div id="edit-profile" class="modal">
            <div class="modal-content center">
                <h6><b>Edit Profile</b></h6>
                <br>
                <form class="row">
                    <div class="divider"></div>
                    <br>
                    <div id="edit-pfp" class="responsive-img circle"></div>
                    <input id="pfp-upload" onchange="pfpUpdate()" type="file" name="file">
                    <br>
                    <div class="input-field col s6">
                        <input placeholder="Placeholder" id="first_name" type="text" class="validate">
                        <label for="first_name">First Name</label>
                    </div>
                    <div class="input-field col s6">
                        <input placeholder="Placeholder" id="first_name" type="text" class="validate">
                        <label for="last">Last Name</label>
                    </div>
                </form>
                <a href="#!" class="modal-close waves-effect waves-cyan btn-flat" onclick="saveEdit()">Save</a>
            </div>
        </div>
        <!-- FOOTER -->
        <div class="end z-depth-0">
            <div class="container">
                <div class="row">
                    <ul class="center">
                        <li class="col s6">
                            <a href="./main.html" class="btn-floating cyan waves-effect"><i
                                    class="material-icons">home</i></a>
                        </li>
                        <li class="col s6">
                            <a href="./profile.html" class="btn-floating disabled cyan waves-effect"><i
                                    class="material-icons">account_circle</i></a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.9.3/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.9.3/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.13.1/firebase-auth.js"></script>

    <script src="../js/app.js"></script>
    <script src="../js/db.js"></script>
    <!-- <script src="../js/ui.js"></script> -->
    <script src="../js/fish.js"></script>
</body>
<script>

    var points = 0;

    $(document).ready(() => {
        $('.modal').modal();
        $('.collapsible').collapsible();
        getProfile();

    });

    function getProfile() {
        var user = $.parseJSON(sessionStorage.user);
        db.collection('users').doc(user.uid).get().then(snapshot => {
            var name = snapshot.data().first_name + " " + snapshot.data().last_name;
            for (var x = 0; x < name.length; x++) {
                name = name.replace(name[x], name[x].toUpperCase());
            }
            $("#profile-data").empty();
            const html = `
                <div id="profile-img">
                    <div id="overlay" class="center white-text"><i class="material-icons medium" style="margin-top: 20%" onClick="openEdit()">edit</i></div>
                    <div id="profile-pfp" class="circle" />
                </div>
                <p><b>${name}</b></p>
                <h4><i>${snapshot.data().username}</i></h4>
                <p id="points">0</p>
            `;
            $("#profile-data").append(html);
            getFish("parent", snapshot.data().username);
            download(user.uid + "/pfp", url => {
                $("#profile-pfp").css("background-image", "url(" + url + ")");
                $("#edit-pfp").css("background-image", "url(" + url + ")");
            })
        })
    }

    function openEdit() {
        var modal = M.Modal.getInstance($("#edit-profile"));
        modal.open();
    }

    function pfpUpdate() {
        var form = $("#edit-profile form");
        const user = JSON.parse(sessionStorage.user);
        upload(form[0].file.files[0], 'temp/' + user.uid, () => {
            download('temp/' + user.uid, url => {
                $("#edit-pfp").css("background-image", "url(" + url + ")");
            })
        })
    }

    function saveEdit() {
        var form = $("#edit-profile input");
        var edit = {
            first_name: form[1].value,
            last_name: form[2].value
        }
        for (var i in edit) {
            if (edit[i] == "") {
                delete edit[i];
            }
        }
        var user = $.parseJSON(sessionStorage.user);
        var form = $("#edit-profile form");
        db.collection("users").doc(user.uid).update(edit).then(() => {
            upload(form[0].file.files[0], user.uid + "/pfp", () => {
                getProfile();
            })

        });
    }

    var isDragging = false;
    var startX, startY;
    $(document)
        .mousedown(e => {
            isDragging = true;
            startX = e.pageX;
            startY = e.pageY;
        })
        .mousemove(e => {
            e.preventDefault();
            if (isDragging) {
                var distanceX = startX - e.pageX;
                var distanceY = startY - e.pageY;
                moveCamera(distanceX, distanceY);
            }
        })
        .mouseup(() => {
            var wasDragging = isDragging;
            isDragging = false;
        });

    $("#light1").on("change", () => {
        var active = findVal($("#light1").find('input[name="group1"]'));
        light2.color.setHex(colours[active]);
    });

    $("#light2").on("change", () => {
        var active = findVal($("#light2").find('input[name="group1"]'));
        light1.color.setHex(colours[active]);
    });

    function findVal(vals) {
        var active;
        vals.each(v => {
            if (vals[v].checked) {
                active = v;
            }
        })
        return active;
    }

</script>

</html>